# Calculate Fake Transfer Entropy

一个用于计算和分析虚假转移熵（Spurious Transfer Entropy）的 Python 工具，用于检测加密货币市场中的虚假因果关系和延迟套利机会。

## 📌 项目简介

本项目通过分析山寨币和 BTC 之间的虚假转移熵和相关系数，识别由共同驱动因素引起的虚假因果关系，并生成交易信号。支持单个币种分析和批量币种分析。

## 🎯 主要功能

1. **数据下载**: 使用 CCXT 从 KuCoin 获取加密货币历史 K 线数据，支持多种时间周期（1m、5m）和数据周期（1d、7d、30d、60d）
2. **批量分析**: 支持分析所有 USDT 交易对与 BTC 的相关系数
3. **数据缓存**: 智能缓存 BTC 数据，避免重复下载，提高分析效率
4. **最优延迟计算**: 通过交叉相关分析找到最优延迟 τ*
5. **虚假转移熵计算**: 计算 T_{ALT → BTC}(τ)
6. **异常检测**: 识别相关系数异常的币种（高相关性但极低相关性并存的情况）
7. **信号生成**: 根据 TE 值生成交易信号
8. **可视化**: 生成分析图表和结果

## 🚀 安装方法

本项目使用 `uv` 进行依赖管理，需要 Python 3.12+ 和 uv 工具。

```bash
# 使用 uv 安装
uv sync
```

或者使用 pip：

```bash
pip install matplotlib numpy pandas pyinform ccxt retry seaborn
```

## 📦 依赖项

- **ccxt**: 从交易所（KuCoin）获取行情数据
- **numpy**: 数值计算
- **pandas**: 数据处理
- **pyinform**: 信息论计算（转移熵）
- **matplotlib**: 数据可视化
- **seaborn**: 高级数据可视化
- **retry**: 自动重试机制，提高数据下载稳定性

## 📁 项目文件结构

```
calculate_fake_TE/
├── main.py                  # 单币种分析脚本（函数式实现）
├── corrcoef_get.py          # 批量相关系数分析工具（类实现）
├── corrcoef_abnormal.py     # 异常币种检测工具（类实现 + 异常过滤）
├── test1_backup.py          # 备份文件（函数式实现）
├── pyproject.toml           # 项目依赖配置（uv）
├── uv.lock                  # 依赖锁定文件
├── README.md                # 项目说明文档
└── spurious_te_kcs_btc.png  # 可视化结果示例（由main.py生成）
```

## 📁 代码文件说明

### main.py
**功能**: 单币种虚假传递熵分析脚本（函数式实现）

**特点**:
- 使用函数式编程，代码简洁
- 专门分析 KCS/USDT 与 BTC/USDT 的关系
- 包含完整的可视化功能
- 计算最优延迟和虚假传递熵，生成交易信号

**使用场景**: 快速测试单个币种的分析流程，查看可视化结果

### corrcoef_get.py
**功能**: 批量相关系数分析工具（类实现）

**特点**:
- 使用 `SpuriousTEAnalyzer` 类封装所有功能
- 自动遍历所有 USDT 交易对
- 输出每个币种在所有时间周期和数据周期组合下的相关系数分析结果
- 智能缓存 BTC 数据，提高效率
- 包含详细的文档字符串和注释

**使用场景**: 全面分析所有币种，获取完整的相关系数数据

### corrcoef_abnormal.py
**功能**: 异常币种检测工具（类实现 + 异常过滤）

**特点**:
- 基于 `SpuriousTEAnalyzer` 类
- 只输出符合异常模式的币种结果
- 包含日志系统，便于追踪分析过程
- 异常模式识别：
  - **模式1**: 短期（1分钟K线）最大相关系数 > 0.4，但长期（60天）最大相关系数 < 0.05
    - 含义：短期存在很大滞后性，但长期跟随性弱，存在时间差套利空间
  - **模式2**: 短期最大相关系数 < 0.11，且长期最大相关系数 < 0.05
    - 含义：币种与BTC相关性极低，可能存在独立走势或异常行为

**使用场景**: 快速识别可能存在套利机会或异常行为的币种

### test1_backup.py
**功能**: 备份文件，功能类似 `corrcoef_get.py` 但使用函数式实现

**特点**:
- 早期版本或备份代码
- 功能与 `corrcoef_get.py` 类似，但代码结构更简单
- 没有类封装，使用独立函数

**使用场景**: 参考或备份用途

## 💻 使用方法

### 1. 单币种分析（main.py）

运行主程序分析 KCS 和 BTC：

```bash
python main.py
```

**程序流程**:
1. 下载 BTC/USDT 和 KCS/USDT 的最近 60 天、5 分钟 K 线数据
2. 对齐时间序列，提取收益率
3. 计算最优延迟 τ*（通过交叉相关分析）
4. 计算虚假转移熵 T_{KCS→BTC}(τ*)
5. 根据 TE 值生成交易信号
6. 生成并保存可视化图表到 `spurious_te_kcs_btc.png`
   - 左图：交叉相关系数 vs 延迟
   - 右图：虚假转移熵 vs 正延迟

**输出示例**:
```
最优延迟 τ* = +5 个 5m bars（约 25 分钟）
虚假转移熵 T_{KCS→BTC}(τ*) = 0.0234 bits
信号: HOLD: 虚假 TE 不足
```

### 2. 批量相关系数分析（corrcoef_get.py）

分析所有 USDT 交易对与 BTC 的相关系数：

```bash
python corrcoef_get.py
```

**功能特点**:
- 自动遍历 KuCoin 交易所中所有 USDT 交易对
- 支持多个时间周期（1m、5m）和数据周期（1d、7d、30d、60d）的组合分析
- 对每个币种，计算所有组合下的最优延迟和最大相关系数
- 输出按相关系数降序排序的结果表格
- BTC 数据智能缓存，避免重复下载（因为 BTC 数据对所有币种都相同）

**输出格式**:
```
============================================================
KCS/USDT相关系数分析结果
============================================================
  最大相关系数  时间周期  数据周期  最优延迟
        0.85      1m       1d        12
        0.78      5m       7d         8
        0.65      1m      30d        15
        0.45      5m      60d         5
============================================================
```

### 3. 异常数据检测（corrcoef_abnormal.py）

检测并输出相关系数异常的币种：

```bash
python corrcoef_abnormal.py
```

**异常检测规则**:
- **异常模式1**: 第一行最大相关系数 > 0.4，且最后一行最大相关系数 < 0.05
  - 表示短期存在很大滞后性，但长期跟随性弱，存在时间差套利空间
- **异常模式2**: 第一行最大相关系数 < 0.11，且最后一行最大相关系数 < 0.05
  - 表示币种与BTC相关性极低，可能存在独立走势或异常行为

**输出特点**:
- 只输出符合异常模式的币种分析结果
- 常规币种只输出简单日志信息（如 "常规数据：ETH/USDT"）
- 使用日志系统记录分析过程

### 自定义分析参数

可以通过修改代码中的参数来自定义分析：

```python
analyzer = SpuriousTEAnalyzer(
    exchange_name="kucoin",           # 交易所名称
    timeout=30000,                     # 请求超时时间（毫秒）
    default_timeframes=["1m", "5m"],   # 时间周期列表
    default_periods=["1d", "7d", "30d", "60d"]  # 数据周期列表
)
analyzer.run(quote_currency="USDT")    # 分析所有 USDT 交易对
```

## 🔬 核心算法原理

### 1. 最优延迟计算（find_optimal_delay）

通过计算不同延迟（lag）下BTC和山寨币收益率的皮尔逊相关系数，找出使相关系数最大的延迟值 τ*。

**算法步骤**:
1. 对于每个延迟 lag ∈ [0, max_lag]：
   - lag = 0: 计算同步相关系数
   - lag > 0: 计算 BTC[t] 与 ALT[t+lag] 的相关系数（ALT滞后BTC）
2. 选择使相关系数最大的 lag 作为最优延迟 τ*
3. 返回 τ*、相关系数曲线和最大相关系数

**意义**: τ* 表示山寨币价格变化滞后于BTC的程度，可用于识别时间差套利机会。

### 2. 虚假传递熵计算（compute_spurious_te）

计算条件互信息 I(X_t; Y_{t-τ} | X_{t-1})，其中：
- X_t: BTC在t时刻的收益率
- X_{t-1}: BTC在t-1时刻的收益率（历史信息）
- Y_{t-τ}: 山寨币在t-τ时刻的收益率（延迟τ）

**算法步骤**:
1. **离散化**: 使用分位数分箱将连续收益率离散化为3个状态（低、中、高）
2. **对齐时间序列**: 确保 X_t、X_{t-1}、Y_{t-τ} 长度一致
3. **统计概率分布**: 
   - p(X_t, X_{t-1}, Y_{t-τ}): 三维联合概率
   - p(X_t, Y_{t-τ}): 二维边际概率
   - p(X_{t-1}, Y_{t-τ}): 二维边际概率
   - p(X_{t-1}): 一维边际概率
4. **计算传递熵**: TE = Σ p(x_t, x_{t-1}, y_{t-τ}) * log₂(p(x_t, x_{t-1}, y_{t-τ}) * p(x_{t-1}) / (p(x_{t-1}, y_{t-τ}) * p(x_t, y_{t-τ})))

**意义**: TE值越大，表示山寨币对BTC的信息传递越强，可能存在虚假因果关系或套利机会。

### 3. 异常模式识别

**模式1**: 短期高相关 + 长期低相关
- 条件: 1分钟K线最大相关系数 > 0.4，且60天最大相关系数 < 0.05
- 含义: 短期存在很大滞后性，但长期跟随性弱，存在时间差套利空间

**模式2**: 极低相关性
- 条件: 1分钟K线最大相关系数 < 0.11，且60天最大相关系数 < 0.05
- 含义: 币种与BTC相关性极低，可能存在独立走势或异常行为

## 📖 API 文档

### 核心类：SpuriousTEAnalyzer

#### `SpuriousTEAnalyzer(exchange_name="kucoin", timeout=30000, default_timeframes=None, default_periods=None)`
创建一个虚假转移熵分析器实例

**参数:**
- `exchange_name`: 交易所名称，默认 "kucoin"
- `timeout`: 请求超时时间（毫秒），默认 30000
- `default_timeframes`: 默认时间周期列表，默认 `["1m", "5m"]`
- `default_periods`: 默认数据周期列表，默认 `["1d", "7d", "30d", "60d"]`

**方法:**

#### `download_ccxt_data(symbol, period, timeframe)`
从 KuCoin 通过 CCXT 下载并处理加密货币数据（带自动重试）

**参数:**
- `symbol`: 加密货币交易对，如 "BTC/USDT"
- `period`: 数据时间范围，如 "60d"
- `timeframe`: 数据间隔，如 "5m"

**返回:**
- DataFrame，包含价格数据、收益率和 USD 交易量

#### `find_optimal_delay(btc_ret, alt_ret, max_lag=48)`
通过交叉相关分析找到最优延迟

**参数:**
- `btc_ret`: BTC 收益率数组
- `alt_ret`: Altcoin 收益率数组
- `max_lag`: 最大延迟范围（单位：bars），默认 48

**返回:**
- `tau_star`: 最优延迟值
- `corrs`: 所有延迟的相关系数数组
- `max_related_matrix`: 最大相关系数值

#### `compute_spurious_te(btc_ret, alt_ret, delay, k=3)`
计算虚假转移熵 T_{ALT → BTC}(τ)

**参数:**
- `btc_ret`: BTC 收益率数组
- `alt_ret`: Altcoin 收益率数组
- `delay`: 延迟值
- `k`: 嵌入维度，默认 3

**返回:**
- 虚假转移熵值（bits）

#### `generate_signal(te_value, threshold=0.05)`
根据 TE 值生成交易信号

**参数:**
- `te_value`: 转移熵值
- `threshold`: 信号阈值，默认 0.05

**返回:**
- 信号字符串："ENTER: 延迟套利信号触发！" 或 "HOLD: 虚假 TE 不足"

#### `one_coin_analysis(coin)`
分析单个币种与 BTC 的相关系数

**参数:**
- `coin`: 币种交易对，如 "KCS/USDT"

**功能:**
- 遍历所有时间周期和数据周期的组合
- 计算每个组合的最优延迟和最大相关系数
- 输出按相关系数排序的结果表格

#### `run(quote_currency="USDT")`
批量分析所有指定计价货币的交易对

**参数:**
- `quote_currency`: 计价货币，默认 "USDT"

**功能:**
- 自动遍历交易所中所有指定计价货币的交易对
- 对每个币种调用 `one_coin_analysis`
- 币种之间自动延迟，避免 API 限流

### 独立函数（main.py）

这些函数也可以独立使用，功能与类方法类似，但仅支持单币种分析。

## 📊 输出结果

### main.py 输出

**控制台输出**:
- 数据下载进度信息
- 最优延迟 τ* 值（单位：bars，括号内显示分钟）
- 虚假转移熵 T_{KCS→BTC}(τ*) 值（单位：bits）
- 交易信号（"ENTER: 延迟套利信号触发！" 或 "HOLD: 虚假 TE 不足"）

**文件输出**:
- `spurious_te_kcs_btc.png`: 包含两个子图的可视化图表
  - **左图**: 交叉相关系数 vs 延迟（-48 到 +48 bars）
    - 蓝色实线：不同延迟下的相关系数曲线
    - 红色虚线：标记最优延迟 τ* 的位置
  - **右图**: 虚假转移熵 vs 正延迟（0 到 24 bars）
    - 红色实线：不同延迟下的传递熵值
    - 红色虚线：标记最优延迟 τ* 的位置
    - 黑色点线：阈值 0.05 bits

### corrcoef_get.py 输出

**控制台输出**:
- 每个币种的数据下载进度信息
- 每个币种的相关系数分析结果表格，包含：
  - **最大相关系数**: 按降序排列（从高到低）
  - **时间周期**: 对应的K线时间周期（1m 或 5m）
  - **数据周期**: 对应的历史数据周期（1d、7d、30d 或 60d）
  - **最优延迟**: 使相关系数最大的延迟值（单位：bars）

**特点**:
- 所有币种都会输出完整的分析结果
- 结果按最大相关系数降序排列，方便识别相关性最强的组合
- BTC 数据缓存信息不会输出（内部处理）

### corrcoef_abnormal.py 输出

**控制台输出**:
- 日志信息（INFO级别）：数据下载和分析进度
- **异常币种**: 符合异常模式的币种会输出完整的相关系数分析表格
  - 格式与 `corrcoef_get.py` 相同
  - 包含最大相关系数、时间周期、数据周期、最优延迟
- **常规币种**: 只输出简单的日志信息（如 "常规数据：ETH/USDT"）

**日志格式**:
```
2024-01-01 12:00:00 - __main__ - INFO - 正在下载 KCS/USDT 的 1m、1d 数据...
2024-01-01 12:00:05 - __main__ - INFO - timeframe: 1m, period: 1d, tau_star: 12, max_related_matrix: 0.85
2024-01-01 12:00:10 - __main__ - INFO - 常规数据：ETH/USDT
```

**异常模式输出示例**:
```
============================================================
KCS/USDT相关系数分析结果
============================================================
  最大相关系数  时间周期  数据周期  最优延迟
        0.85      1m       1d        12
        0.78      5m       7d         8
        0.65      1m      30d        15
        0.03      5m      60d         5
============================================================
```

## ⚠️ 注意事项

- **数据可靠性**: 依赖交易所（KuCoin）与 CCXT 的数据质量与限频
- **计算复杂度**: 批量分析所有币种可能需要较长时间
- **API 限流**: 程序已内置重试机制和延迟策略，但仍需注意交易所 API 限制
- **信号有效性**: 仅供参考，不构成投资建议
- **BTC 数据缓存**: 批量分析时会自动缓存 BTC 数据，提高效率

## 🔧 技术特性

- **自动重试**: 使用 `@retry` 装饰器实现数据下载的自动重试（最多 10 次，指数退避）
- **数据缓存**: BTC 数据按 `(timeframe, period)` 组合缓存，避免重复下载
- **错误处理**: 完善的异常处理和数据验证机制
- **灵活配置**: 支持自定义时间周期、数据周期和交易所

## 🔄 未来改进

1. ✅ 支持更多加密货币对的分析（已实现）
2. 添加回测功能验证信号有效性
3. 优化算法提高计算速度
4. ✅ 增加错误处理和交易所 API 限流处理（已实现）
5. 支持更多交易所
6. 添加数据持久化功能

## 📚 参考资料

更多关于 Transfer Entropy 的理论和应用，请参考信息论和因果推断相关文献。本项目用于学术研究和教学目的。

## 🤝 贡献

欢迎提交 Issue 或 Pull Request！

## 📄 许可证

本项目使用 MIT 许可证
